#!/bin/sh

dir="$(pwd)"
cd "$(dirname "$0")"
cd ..
home="$(pwd)"
bin="${home}/bin"
cd "${dir}"

if [ ! -z ${LUMEN_HOST} ]; then host=${LUMEN_HOST}
elif luajit -v > /dev/null 2>&1; then host=luajit
elif    lua -v > /dev/null 2>&1; then host=lua
elif   node -v > /dev/null 2>&1; then host=node
else
    1>&2 echo "no host found"
    exit 1
fi
export LUMEN_HOST="${host}"

case $host in
    node*)
        ext=js
        export NODE_PATH="$NODE_PATH:${bin}:${dir}/lib";;
    *)
        ext=lua
        export LUA_PATH="$LUA_PATH;${bin}/?.lua;${dir}/lib/?.lua;;";;
esac

if [ ! -z "${REBUILD}" ]; then
  #
  # Rebuild Monki.
  #
  obj="${home}/obj"
  lumen_bin="${home}/lumen/bin"
  lumen="${home}/lumen/bin/lumen"
  if [ ! -e "${lumen}" ]; then 1>&2 echo "Lumen not found" && exit 1; fi

  for target in "js" "lua"; do
      cd "${bin}"
      git checkout *.${target}
      cd "${dir}"
      cp "${lumen_bin}/"*.${target} "${bin}/"
  done

  rm -f "${obj}/"*.js "${obj}/"*.lua

  for target in "js" "lua"; do
      "${lumen}" -c "${home}/sudoarc.l" -o "${obj}/sudoarc.${target}" -t ${target}
  done

  for target in "js" "lua"; do
    "${lumen}" "${obj}/sudoarc.${ext}" -c "${home}/main.l" -o "${obj}/main.${target}" -t ${target}
    cat "${lumen_bin}/lumen.${target}" | grep -v '^main\(\)' > "${bin}/monki.${target}"
    for src in "sudoarc" "main"; do
        cat "${obj}/${src}.${target}" >> "${bin}/monki.${target}"
    done
    echo "main()" >> "${bin}/monki.${target}"
  done
fi

if [ -z "${REPL}" ]; then
  args="-e nil"
fi

rlwrap="`which rlwrap`"
if [ ! -z "$rlwrap" ]; then
  cmdline="$@" exec "${rlwrap}" "${host}" "${bin}/monki.${ext}" $args
else
  cmdline="$@" exec             "${host}" "${bin}/monki.${ext}" $args
fi

