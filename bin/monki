#!/bin/sh

dir="$(pwd)"
cd "$(dirname "$0")"
bin="$(pwd)"
cd ..
lumen_bin="lumen/bin"
if [[ ! -d "${lumen_bin}" ]]; then
  1>&2 echo "Lumen not found" && exit 1;
fi
cd "${dir}"

if [ ! -z ${LUMEN_HOST} ]
then
    host=${LUMEN_HOST}
elif luajit -v > /dev/null 2>&1
then
    host=luajit
elif lua -v > /dev/null 2>&1
then
    host=lua
elif node -v > /dev/null 2>&1
then
    host=node
else
    echo "no Lumen host found"
fi

case $host in
    node*)
        ext=js
        export NODE_PATH="$NODE_PATH:${bin}:${dir}/lib";;
    *)
        ext=lua
        export LUA_PATH="$LUA_PATH;${bin}/?.lua;${dir}/lib/?.lua;;";;
esac

git checkout "${bin}/"*.{js,lua}

cp "${lumen_bin}/"*.{js,lua} "${bin}/"

for src in "monki" "sudoarc"; do
  for target in "js" "lua"; do
    ${host} "${bin}/lumen.${ext}" -c "${src}.l" -o "${bin}/${src}.${target}" -t ${target}
  done
done

rlwrap="`which rlwrap`"

if [ ! -z "$rlwrap" ]; then
  exec "${rlwrap}" ${host} "${bin}/"{lumen,monki,sudoarc}".${ext}" "$@"
else
  exec             ${host} "${bin}/"{lumen,monki,sudoarc}".${ext}" "$@"
fi

