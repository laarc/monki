#!/bin/sh

dir="$(pwd)"
cd "$(dirname "$0")"
bin="$(pwd)"
cd ../obj
obj="$(pwd)"
cd ..
lumen_bin="lumen/bin"
if [ ! -d "${lumen_bin}" ]; then
  1>&2 echo "Lumen not found" && exit 1;
fi
cd "${dir}"

if [ ! -z ${LUMEN_HOST} ]
then
    host=${LUMEN_HOST}
elif luajit -v > /dev/null 2>&1
then
    host=luajit
elif lua -v > /dev/null 2>&1
then
    host=lua
elif node -v > /dev/null 2>&1
then
    host=node
else
    echo "no Lumen host found"
fi

case $host in
    node*)
        ext=js
        export NODE_PATH="$NODE_PATH:${bin}:${dir}/lib";;
    *)
        ext=lua
        export LUA_PATH="$LUA_PATH;${bin}/?.lua;${dir}/lib/?.lua;;";;
esac

for ext in "js" "lua"; do
    git checkout "${bin}/"*.${ext}
    cp "${lumen_bin}/"*.${ext} "${bin}/"
done

for target in "js" "lua"; do
  rm -f "${obj}/"*.${target}
  for src in "sudoarc" "monki"; do
    ${host} "${lumen_bin}/lumen.${ext}" -c "${src}.l" -o "${obj}/${src}.${target}" -t ${target}
  done
  code="${bin}/monki.${target}"
  cat "${lumen_bin}/lumen.${target}" | grep -v '^main\(\)' > "${code}"
  for src in "sudoarc"; do
      cat "${obj}/${src}.${target}" >> "${code}"
  done
  echo "main()" >> "${code}"
done

cmdline="$@"

rlwrap="`which rlwrap`"

if [ ! -z "$rlwrap" ]; then
  cmdline="${cmdline}" exec "${rlwrap}" "${host}" "${bin}/monki.${ext}"     
else
  cmdline="${cmdline}" exec             "${host}" "${bin}/monki.${ext}"     
fi

