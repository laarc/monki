#!/bin/sh

dir="$(pwd)"
cd "$(dirname "$0")"
bin="$(pwd)"
cd ..
home="$(pwd)"
cd obj
obj="$(pwd)"
cd ../lumen/bin
lumen_bin="$(pwd)"
if [ ! -d "${lumen_bin}" ]; then
  1>&2 echo "Lumen not found" && exit 1;
fi
cd "${dir}"

if [ ! -z ${LUMEN_HOST} ]
then
    host=${LUMEN_HOST}
elif luajit -v > /dev/null 2>&1
then
    host=luajit
elif lua -v > /dev/null 2>&1
then
    host=lua
elif node -v > /dev/null 2>&1
then
    host=node
else
    echo "no Lumen host found"
fi

case $host in
    node*)
        ext=js
        export NODE_PATH="$NODE_PATH:${bin}:${dir}/lib";;
    *)
        ext=lua
        export LUA_PATH="$LUA_PATH;${bin}/?.lua;${dir}/lib/?.lua;;";;
esac

for ext in "js" "lua"; do
    git checkout "${bin}/"*.${ext}
    cp "${lumen_bin}/"*.${ext} "${bin}/"
done

rm -f "${obj}/"*.js  "${obj}/"*.lua

for target in "js" "lua"; do
    ${host} "${lumen_bin}/lumen.${ext}" \
        -c "${home}/sudoarc.l" -o "${obj}/sudoarc.${target}" -t ${target}
done

for target in "js" "lua"; do
  for src in "main"; do
      ${host} "${lumen_bin}/lumen.${ext}" "${obj}/sudoarc.${ext}" \
          -c "${home}/${src}.l" -o "${obj}/${src}.${target}" -t ${target}
  done
  cat "${lumen_bin}/lumen.${target}" | grep -v '^main\(\)' > "${bin}/monki.${target}"
  for src in "sudoarc" "main"; do
      cat "${obj}/${src}.${target}" >> "${bin}/monki.${target}"
  done
  echo "main()" >> "${bin}/monki.${target}"
done

if [ ! -z "$rlwrap" ]; then
  cmdline="$@" exec "${rlwrap}" "${host}" "${bin}/monki.${ext}"     
else
  cmdline="$@" exec             "${host}" "${bin}/monki.${ext}"     
fi

